<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  font: 10px sans-serif;
  shape-rendering: crispEdges;
}

.hh {
  fill: #fff;
  stroke: #222;
}

text.m {
  font-size: 7pt;
  font-family: Consolas, courier;
  fill: #666;
}

text.title {
  font-size: 12pt;
  font-family: Consolas, courier;
  fill: #666;
}

</style>
<body>
<script src="d3/d3.v3.min.js"></script>
<script src="date.js"></script>
<script>

// Inspired from example at: http://bl.ocks.org/mbostock/4063318
// Another good example could be: http://bl.ocks.org/tjdecke/5558084
// Another example for analysis of hourly patterns within a week could be: http://prcweb.co.uk/lab/circularheat/
// Using the floor plan with D3: http://dciarletta.github.io/d3-floorplan/
var QueryString = function () {
  // This function is anonymous, is executed immediately and 
  // the return value is assigned to QueryString!
  var query_string = {};
  var query = window.location.search.substring(1);
  var vars = query.split("&");
  for (var i=0;i<vars.length;i++) {
    var pair = vars[i].split("=");
      // If first entry with this name
    if (typeof query_string[pair[0]] === "undefined") {
      query_string[pair[0]] = pair[1];
      // If second entry with this name
    } else if (typeof query_string[pair[0]] === "string") {
      var arr = [ query_string[pair[0]], pair[1] ];
      query_string[pair[0]] = arr;
      // If third or later entry with this name
    } else {
      query_string[pair[0]].push(pair[1]);
    }
  } 
    return query_string;
} ();

// Current client
var clientId = QueryString.client_id;

// Various variables :-)
var data,color;
var cellSize = 7;
var nbPrdByDay = 48;
var offset = 0;
var nbDays = 365;
var width = (nbDays+1)*cellSize*2,
    height = (nbPrdByDay+1)*cellSize+150;
var hourPrd = {
  1:"00:30", 2:"01:00", 3:"01:30", 4:"02:00", 5:"02:30", 6:"03:00", 7:"03:30", 8:"04:00",
  9:"04:30", 10:"05:00",11:"05:30",12:"06:00",13:"06:30",14:"07:00",15:"07:30",16:"08:00",
  17:"08:30",18:"09:00",19:"09:30",20:"10:00",21:"10:30",22:"11:00",23:"11:30",24:"12:00",
  25:"12:30",26:"13:00",27:"13:30",28:"14:00",29:"14:30",30:"15:00",31:"15:30",32:"16:00",
  33:"16:30",34:"17:00",35:"17:30",36:"18:00",37:"18:30",38:"19:00",39:"19:30",40:"20:00",
  41:"20:30",42:"21:00",43:"21:30",44:"22:00",45:"22:30",46:"23:00",47:"23:30",48:"23:59"
};

// Constant
var dateStart = Date.parse('January 1st 2010');

// Conversion of a date number into the readable date (for hover)
var dayToString  = function(inData,format){
  // Offset from start day
  var dt = new Date(dateStart).add(parseInt(inData)-1).days();
  // Default string
  return dt.toString(format);
}

// Using a single range (may use months/quarters ranges at a later stage)
var svg = d3.select("body").selectAll("svg")
    .data(d3.range(1, 2))
  .enter().append("svg")
    .attr("width", width)
    .attr("height", height)
    .attr("class", "RdYlGn")
  .append("g")
    .attr("transform", "translate(" + 40 + "," + 20 + ")");

// Ingestion of the client data as served by the web service (JSON)
d3.json("ws/ws_consumption_by_client.php?client_id="+clientId, function(error, json) {
  if (error) return console.warn(error);
  data = json.rows;

  // Number of days that are first of the month (i.e. to label)
  var datesToLabel=[];

  var currentData, minData, maxData, avgData = 0.0;
  for (i in data)
  {
    currentData = parseFloat(data[i].k);

    if (!minData || minData > currentData)
    {
      minData = currentData;
    }
    if (!maxData || maxData < currentData)
    {
      maxData = currentData;
    }
    avgData += currentData;

    if (data[i].p ==1 && dayToString(data[i].d,'d')=="1")
    {
      datesToLabel.push(data[i].d);
    }
  }

  minData = parseFloat(minData);
  maxData = parseFloat(maxData);
  avgData = (minData+maxData)/2;

  // Number of days to substract, so that the first data day is 1
  var dayStart = data[0].d-1;

  color = d3.scale.linear()
    .domain([minData, avgData, maxData])
    .range(["green", "yellow", "red"]);

  // Request only as many days as the data can support
  nbDays = Math.min(nbDays,data.length/nbPrdByDay);

  var rect = svg.selectAll(".hh")
    .data(
      d3.range(1+(offset*nbPrdByDay),nbPrdByDay*(nbDays+offset)+1)
    )
    .enter().append("rect")
      .attr("width", cellSize)
      .attr("height", cellSize)
  ;

  rect.
    attr("class", function(d) {
        return "hh";
    })
    .attr("style", function(d) {
      return "fill:"+color(data[d-1].k)+";";
    })
    .attr("x", function(d) {
      return (data[d-1].d-dayStart) * cellSize; 
    })
    .attr("y", function(d) { 
      return data[d-1].p * cellSize; 
    })
    .append("title")
      .text(function(d) {
        return dayToString(data[d-1].d,'dd/MM/yy')+" ("+hourPrd[data[d-1].p]+"): "+data[d-1].k+"kWh";
      });

  // Adding the labels for the hours
  var hourLabels = svg.selectAll(".hl")
      .data(d3.range(1,48))
      .enter().append("text")
        .text(function (d) { 
          return hourPrd[d];
        })
        .attr("x", -30)
        .attr("y", function (d, i) { return i * cellSize + 3*cellSize-6; })
        .attr("class", function (d, i) { return "hl m"; });

  var monthLabel = svg.selectAll(".ml")
      .data(d3.range(1,datesToLabel.length+1))
      .enter().append("text")
        .text(function (d) { 
          return dayToString(datesToLabel[d-1],'MMMM');
        })
        .attr("x", function (d, i) {
          return (datesToLabel[d-1]-dayStart + 10) * cellSize;
        })
        .attr("y", -4)
        .attr("class", function (d, i) { return "ml title"; });

  var monthFirstLabel = svg.selectAll(".mfl")
      .data(d3.range(1,datesToLabel.length+1))
      .enter().append("text")
        .text(function (d) { 
          return '|';
        })
        .attr("x", function (d, i) {
          return (datesToLabel[d-1]-dayStart-1/2) * cellSize+0.5;
        })
        .attr("y", cellSize/2+2)
        .attr("class", function (d, i) { return "mfl m"; });

});

d3.select(self.frameElement).style("height", "2910px");

</script></body></html>